<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FedNow Processor API Documentation</title>
    <link rel="stylesheet" type="text/css" href="https://unpkg.com/swagger-ui-dist@5.10.3/swagger-ui.css" />
    <style>
        html {
            box-sizing: border-box;
            overflow: -moz-scrollbars-vertical;
            overflow-y: scroll;
        }
        *, *:before, *:after {
            box-sizing: inherit;
        }
        body {
            margin:0;
            background: #fafafa;
        }
        .swagger-ui .topbar {
            background-color: #2c3e50;
        }
        .swagger-ui .topbar .download-url-wrapper {
            display: none;
        }
        
        /* Token management panel */
        .token-panel {
            position: fixed;
            top: 10px;
            right: 10px;
            background: #fff;
            border: 2px solid #2c3e50;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            z-index: 9999;
            max-width: 350px;
            font-family: Arial, sans-serif;
        }
        
        .token-panel h3 {
            margin: 0 0 10px 0;
            color: #2c3e50;
            font-size: 14px;
        }
        
        .token-panel input {
            width: 100%;
            padding: 8px;
            margin: 5px 0;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 11px;
            box-sizing: border-box;
        }
        
        .token-panel button {
            background: #2c3e50;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            margin: 2px;
        }
        
        .token-panel button:hover {
            background: #34495e;
        }
        
        .status {
            font-size: 11px;
            margin: 5px 0;
            padding: 5px;
            border-radius: 3px;
        }
        
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
        
        .token-panel .minimize {
            position: absolute;
            top: 5px;
            right: 8px;
            background: none;
            border: none;
            font-size: 16px;
            cursor: pointer;
            color: #666;
        }
        
        .token-panel.minimized {
            height: 40px;
            overflow: hidden;
        }

        .debug-info {
            font-size: 10px;
            background: #f8f9fa;
            padding: 5px;
            border-radius: 3px;
            margin: 5px 0;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <!-- Token Management Panel -->
    <div id="tokenPanel" class="token-panel">
        <button class="minimize" onclick="togglePanel()">‚àí</button>
        <h3>üîê Token Manager v2</h3>
        <div class="content">
            <input type="text" id="tempToken" placeholder="Paste temp token here" />
            <button onclick="setTempToken()">Set Temp Token</button>
            
            <input type="text" id="permToken" placeholder="Paste permanent token here" />
            <button onclick="setPermToken()">Set Perm Token</button>
            
            <button onclick="clearTokens()">Clear All</button>
            <button onclick="testRequest()">Test Request</button>
            
            <div id="status" class="status info">
                Ready to set tokens manually
            </div>

            <div id="debugInfo" class="debug-info">
                Debug info will appear here
            </div>
        </div>
    </div>

    <div id="swagger-ui"></div>
    
    <script src="https://unpkg.com/swagger-ui-dist@5.10.3/swagger-ui-bundle.js"></script>
    <script src="https://unpkg.com/swagger-ui-dist@5.10.3/swagger-ui-standalone-preset.js"></script>
    <script>
        // Token storage
        let currentTempToken = '';
        let currentPermToken = '';
        let originalRequestInterceptor = null;
        
        // UI Functions
        function togglePanel() {
            const panel = document.getElementById('tokenPanel');
            const btn = panel.querySelector('.minimize');
            panel.classList.toggle('minimized');
            btn.textContent = panel.classList.contains('minimized') ? '+' : '‚àí';
        }
        
        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }

        function updateDebugInfo(message) {
            const debug = document.getElementById('debugInfo');
            debug.textContent = message;
        }
        
        function setTempToken() {
            const token = document.getElementById('tempToken').value.trim();
            if (token) {
                currentTempToken = token;
                updateStatus('‚úÖ Temp token set successfully', 'success');
                updateDebugInfo(`Temp token: ${token.substring(0, 20)}...`);
                console.log('üîß Temp token set:', token.substring(0, 50) + '...');
            } else {
                updateStatus('‚ùå Please enter a token', 'error');
            }
        }
        
        function setPermToken() {
            const token = document.getElementById('permToken').value.trim();
            if (token) {
                currentPermToken = token;
                updateStatus('‚úÖ Permanent token set successfully', 'success');
                updateDebugInfo(`Perm token: ${token.substring(0, 20)}...`);
                console.log('üîß Permanent token set:', token.substring(0, 50) + '...');
            } else {
                updateStatus('‚ùå Please enter a token', 'error');
            }
        }
        
        function clearTokens() {
            currentTempToken = '';
            currentPermToken = '';
            document.getElementById('tempToken').value = '';
            document.getElementById('permToken').value = '';
            updateStatus('üßπ All tokens cleared', 'info');
            updateDebugInfo('Tokens cleared');
            console.log('üßπ All tokens cleared');
        }

        function testRequest() {
            updateStatus('üß™ Testing request interceptor...', 'info');
            console.log('üß™ Test - Current tokens:', {
                temp: currentTempToken ? currentTempToken.substring(0, 20) + '...' : 'none',
                perm: currentPermToken ? currentPermToken.substring(0, 20) + '...' : 'none'
            });
        }
        
        // Enhanced request interceptor
        function createRequestInterceptor() {
            return function(request) {
                console.log('üîç Request interceptor called for:', request.url);
                
                // Always include credentials
                request.credentials = 'include';
                
                // Initialize headers if not present
                if (!request.headers) {
                    request.headers = {};
                }
                
                let tokenUsed = '';
                let cookieValue = '';
                
                // Determine which token to use
                if (request.url.includes('/login-otp-validation')) {
                    if (currentTempToken) {
                        cookieValue = `bearer-token-temp-internal=${currentTempToken}`;
                        tokenUsed = 'temp';
                        console.log('üéØ Using TEMP token for OTP validation');
                    } else {
                        console.log('‚ùå No temp token available for OTP validation');
                    }
                } else if (!request.url.includes('/user-login/new-session')) {
                    if (currentPermToken) {
                        cookieValue = `bearer-token-perm-internal=${currentPermToken}`;
                        tokenUsed = 'perm';
                        console.log('üéØ Using PERMANENT token for API call');
                    } else {
                        console.log('‚ùå No permanent token available');
                    }
                }
                
                // Add cookie header if we have a token
                if (cookieValue) {
                    request.headers['Cookie'] = cookieValue;
                    console.log('‚úÖ Added Cookie header:', cookieValue.substring(0, 50) + '...');
                    updateStatus(`üîÑ Using ${tokenUsed} token`, 'info');
                } else {
                    console.log('‚ö†Ô∏è No token added to request');
                }
                
                // Log final request details
                console.log('üì§ Final request:', {
                    url: request.url,
                    method: request.method,
                    headers: request.headers,
                    credentials: request.credentials
                });
                
                return request;
            };
        }
        
        // Initialize Swagger UI
        window.onload = function() {
            console.log('üöÄ Initializing Swagger UI...');
            
            // Inline YAML spec (replace with your actual YAML content)
            const yamlSpec = `
openapi: 3.0.3
info:
  title: Fednow processor action APIs
  description: |
    This is detailed documentation for simulator Fednow processor action APIs
    
    ## Successful Authentication is required to call following APIs.
    
    ## üîê Authentication Flow
    
    The API uses a secure two-step cookie-based authentication system:
    
    ### Step 1: Initial Login
    **Endpoint**: \`POST /authn/user-login/new-session\`
    - Send your user ID to initiate a new session
    - Receive temporary authentication cookie (\`bearer-token-temp-internal\`)
    - Cookie expires in 5 minutes for security
    - OTP is sent to your registered email address
    
    ### Step 2: OTP Validation  
    **Endpoint**: \`POST /authn/login-otp-validation\`
    - Submit the OTP received via email
    - Use the temporary cookie from Step 1
    - Receive permanent authentication cookie (\`bearer-token-perm-internal\`)
    - Cookie remains valid for 12 hours
    
    ### Step 3: API Access
    - All protected endpoints automatically use the permanent cookie
    - No need to manually handle authentication headers
    - Swagger UI manages cookies automatically
    
    
  version: 1.0.0
  
servers:
- url: https://arthanova.cloudjiffy.net

# Add your full YAML content here...
`;
            
            const ui = SwaggerUIBundle({
                spec: YAML.parse(yamlSpec), // Parse YAML string
                dom_id: '#swagger-ui',
                deepLinking: true,
                presets: [
                    SwaggerUIBundle.presets.apis,
                    SwaggerUIStandalonePreset
                ],
                plugins: [
                    SwaggerUIBundle.plugins.DownloadUrl
                ],
                layout: "StandaloneLayout",
                tryItOutEnabled: true,
                filter: true,
                supportedSubmitMethods: ['get', 'post', 'put', 'delete', 'patch'],
                requestInterceptor: createRequestInterceptor(),
                responseInterceptor: (response) => {
                    console.log('üì• Response received:', {
                        url: response.url,
                        status: response.status,
                        headers: [...response.headers.entries()]
                    });
                    
                    // Try to extract tokens from response
                    const setCookieHeader = response.headers.get('set-cookie');
                    if (setCookieHeader) {
                        console.log('üç™ Set-Cookie header found:', setCookieHeader);
                        
                        if (setCookieHeader.includes('bearer-token-temp-internal')) {
                            const match = setCookieHeader.match(/bearer-token-temp-internal=([^;]+)/);
                            if (match) {
                                console.log('üéØ Auto-extracted temp token');
                                // Don't auto-set, let user do it manually for better control
                            }
                        }
                        
                        if (setCookieHeader.includes('bearer-token-perm-internal')) {
                            const match = setCookieHeader.match(/bearer-token-perm-internal=([^;]+)/);
                            if (match) {
                                console.log('üéØ Auto-extracted permanent token');
                                // Don't auto-set, let user do it manually for better control
                            }
                        }
                    }
                    
                    return response;
                },
                onComplete: function() {
                    console.log("‚úÖ Swagger UI loaded successfully");
                    updateStatus('üöÄ Swagger UI ready - Enhanced v2', 'success');
                    updateDebugInfo('UI loaded, ready for tokens');
                }
            });
            
            // Store reference for debugging
            window.swaggerUI = ui;
        };

        // Global debug functions
        window.debugTokens = function() {
            console.log('üîç Debug Info:', {
                tempToken: currentTempToken ? 'SET (' + currentTempToken.length + ' chars)' : 'NOT SET',
                permToken: currentPermToken ? 'SET (' + currentPermToken.length + ' chars)' : 'NOT SET',
                cookies: document.cookie
            });
        };
    </script>
</body>
</html>
